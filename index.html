<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Benchmark Performance</title>
		<script type="text/javascript" src="d3.v3.js"></script>
		<style type="text/css">
            .axis path,
            .axis line {
                    fill: none;
                    stroke: grey;
                    shape-rendering: crispEdges;
            }

            .label text {
                    font-family: sans-serif;
                    font-size: 12px;
            }
            .axis text {
                    font-family: sans-serif;
                    font-size: 10px;
            }

            .xaxis text {
                    font-weight: bold;
                    font-size: 11px;
            }

		</style>
	</head>
	<body>
		<script type="text/javascript">

			var w = 800;
			var h = 400;
            var axis_w = 40;
            var headroom = 10;
            var footroom = 40;

            //benchmark = set of bars
            //series = one bar in each set
            //time = y axis (normalized)
            var benchmark = d3.scale.ordinal()
            var time = d3.scale.log()
                        .range([h, 0])

			var svg = d3.select("body")
						.append("svg")
						.attr("width", w+axis_w)
						.attr("height", h+headroom+footroom);
            var plot = svg.append("g")
                        .attr("transform", "translate("+String(axis_w)+","+String(headroom)+")")
            var footer = svg.append("g")
                        .attr("transform", "translate("+String(axis_w)+","+String(headroom+h)+")")

            var colors = ["red", "green", "blue", "#E0B0FF"]
            d3.json("data.json", function(err, parsed) {
                    var series = parsed.series;
                    var benchmarks = parsed.benchmarks;
                    benchmark.domain(benchmarks.map(function (a) { return a[0]; }));
                    benchmark.rangeRoundBands([0,w],0.3,0.1)
                    var bar_width = benchmark.rangeBand() / (series.length - 1);

                    time.domain([0.1, 10]); // Make more general or data-dependent?
                    var timeOf1 = time(1);

                    var baseline = 0;

                    var entering = plot.selectAll("rect")
                                    .data(benchmarks)
                                    .enter()

                    function drawBars(index){
                        if (index == baseline){
                            entering.append("rect")
                               .attr("x", function(d) {
                                    return benchmark(d[0]) + index*bar_width;
                               })
                               .attr("y", timeOf1)
                               .attr("width", 0.001)
                               .attr("height", 0.001)
                               .attr("fill", "white")

                        }else{
                            entering.append("rect")
                               .attr("x", function(d) {
                                    var offset = index > baseline ? index-1 : index;
                                    return benchmark(d[0]) + offset*bar_width;
                               })
                               .attr("y", function(d) {
                                    var val = +(d[1][index]) / +(d[1][baseline])
                                    if (val > 1) { return time(val); }
                                    return timeOf1;
                               })
                               .attr("width", bar_width)
                               .attr("height", function(d){
                                    return Math.abs(time(+(d[1][index]) / +(d[1][baseline])) - timeOf1);
                               })
                               .attr("fill", colors[index])
                               .on("click", function(d, i) { baseline = index; update();});
                            }

                    }
                    function update(){
                        svg.selectAll("rect").remove();
                        for(var i = 0; i < series.length; i++){
                             drawBars(i);
                        }
                        legend();
                    }
                    update();

                    plot.append("g")
                       .attr("class", "axis xaxis")
                       .attr("transform", "translate(0," + timeOf1 + ")")
                       .call(d3.svg.axis().scale(benchmark))

                    //Remove underscores
                    plot.selectAll("text")
                        .text(function(d){ return d.split('_').join(' '); })

                    svg.append("g")
                       .attr("class", "axis")
                       .attr("transform", "translate("+String(axis_w)+","+String(headroom)+")")
                       .call(d3.svg.axis()
                               .scale(time)
                               .orient("left")
                               .tickFormat(d3.format(".1f"))
                            )
                    svg.append("text")
                       .attr("class", "label")
                       .attr("text-anchor", "middle")
                       .attr("transform", "translate(10,"+(timeOf1+headroom)+"), rotate(-90)")
                       //class isn't working?
                       .style("font-family", "sans-serif")
                       .style("font-size", "12px")
                       .text("Speed-Up Factor Over Baseline");

                    function legend(){
                        footer.selectAll("text").remove();
                        footer.selectAll("text")
                            .data(series)
                            .enter()
                            .append("text")
                            .attr("fill", function(d, i){
                                if (baseline == i) {return "black";}
                                return colors[i];
                                })
                            .attr("text-anchor", "middle")
                            .attr("transform", function(d,i){
                                    return "translate("+String(axis_w + ((i+1)*w/6))+",15)";
                                })
                            .style("font-family", "sans-serif")
                            .style("font-weight", function(d, i){
                                return baseline == i ? "bold" : "normal"
                                })
                            .text(function(d){ return d.split('_').join(' '); })
                    }


                });

		</script>
	</body>
</html>
